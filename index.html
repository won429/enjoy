<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Play enjoy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- í°íŠ¸ ì¶”ê°€ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/HakgyoansimDunggeunmiso/HakgyoansimDunggeunmiso.css" type="text/css"/>
    
    <style>
        /* í°íŠ¸ ë° ê¸°ë³¸ ì„¤ì • */
        @font-face {
            font-family: 'GmarketSansMedium';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; 
            overscroll-behavior: none;
            font-family: 'GmarketSansMedium', -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Pretendard", Roboto, "Noto Sans KR", sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #ffffff;
        }
        .font-logo { font-family: 'Hakgyoansim Dunggeunmiso', sans-serif; font-weight: 700; }
        .font-lyrics { font-family: 'Pretendard', sans-serif; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin-lp { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .lp-animation { animation: spin-lp 10s linear infinite; animation-play-state: paused; }
        .lp-animation.running { animation-play-state: running; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .smooth-transition { transition: width 0.1s linear, left 0.1s linear; }
        .no-transition { transition: none !important; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; box-shadow: none; border: none; }
        .fade-out { opacity: 0; visibility: hidden; transition: opacity 0.8s ease-out, visibility 0.8s; }
        
        .lp-texture {
            background: repeating-radial-gradient(#111 0, #111 2px, #1a1a1a 3px, #111 4px);
        }
        
        /* ê°€ì‚¬ ìŠ¤íƒ€ì¼ */
        .lyric-line {
            transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1), 
                        opacity 0.6s cubic-bezier(0.22, 1, 0.36, 1),
                        filter 0.6s cubic-bezier(0.22, 1, 0.36, 1),
                        color 1.2s ease-in-out; 
            
            opacity: 0.4; 
            transform: scale(0.95) translateX(0);
            transform-origin: left center;
            filter: blur(1px); 
            font-size: 1.8rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.35); 
            margin-bottom: 2.5rem;
            line-height: 1.6;
            cursor: pointer;
            will-change: transform, opacity, filter, color;
            
            white-space: pre-wrap;       
            word-break: keep-all;        
            overflow-wrap: break-word;   
            width: fit-content;
            max-width: 85%;             
        }

        .lyric-line:hover { opacity: 0.6; color: rgba(255, 255, 255, 0.6); }

        .lyric-line.active {
            opacity: 1 !important;
            transform: scale(1.08) translateX(5px); 
            filter: blur(0);
            color: #ffffff !important; 
            text-shadow: 0 4px 30px rgba(0, 0, 0, 0.6); 
        }

        .lyrics-mask {
            mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 85%, transparent 100%);
        }

        /* ê°€ì‚¬ í™”ë©´ íŠ¸ëœì§€ì…˜ - ìŠ¬ë¼ì´ë“œ íš¨ê³¼ */
        #lyrics-overlay {
            transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            overscroll-behavior: none;
            z-index: 60; 
        }
        
        /* ë‹«í ë•Œ: í™”ë©´ ì•„ë˜ë¡œ ì™„ì „íˆ ë‚´ë ¤ê° */
        .lyrics-closed {
            transform: translateY(100%);
        }
        /* ì—´ë¦´ ë•Œ: í™”ë©´ì„ ë®ìŒ */
        .lyrics-open {
            transform: translateY(0);
        }

        /* íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="text-black overflow-hidden select-none h-[100dvh] w-screen fixed bg-white">

    <!-- ì¸íŠ¸ë¡œ -->
    <div id="boot-screen" class="fixed inset-0 z-[100] bg-white flex items-center justify-center cursor-pointer transition-opacity duration-1000">
        <img src="./intro.jpg" class="w-full h-full object-cover animate-pulse" onerror="this.style.display='none';">
        <div id="intro-fallback" class="hidden flex flex-col items-center gap-4">
             <h1 class="font-logo tracking-tight text-black text-4xl lowercase">Play enjoy</h1>
        </div>
    </div>

    <!-- ê³µì§€ì‚¬í•­ íŒì—… (ì„¹ì…˜ ë¶„ë¦¬ ë””ìì¸ ì ìš©) -->
    <div id="notice-modal" class="fixed inset-0 z-[70] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-2xl p-0 w-full max-w-xs text-center shadow-2xl border border-gray-100 scale-in relative overflow-hidden">
            <!-- í—¤ë” -->
            <div class="bg-[#005ED2]/5 p-4 pb-2">
                <div class="w-10 h-10 bg-[#005ED2]/10 rounded-full flex items-center justify-center mx-auto mb-2 text-[#005ED2]">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                </div>
                <h3 id="notice-title" class="text-lg font-bold text-black">ì—…ë°ì´íŠ¸ & ì‹ ê³¡ ì•ˆë‚´</h3>
            </div>

            <div class="p-5 space-y-4 text-left">
                <!-- ì—…ë°ì´íŠ¸ ì„¹ì…˜ -->
                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-green-100 text-green-600 text-[10px] font-bold px-1.5 py-0.5 rounded">UPDATE</span>
                        <span class="text-xs font-bold text-gray-700">ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸</span>
                    </div>
                    <!-- ID ì¶”ê°€: update-content -->
                    <p id="update-content" class="text-xs text-gray-500 leading-relaxed pl-1">ğŸ“Š ì—”ì¡°ì´ ì°¨íŠ¸ ì§‘ê³„ ì‹œì‘!<br>(ë…¸ë˜ë¥¼ ì¬ìƒí•˜ë©´ ìˆœìœ„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤)</p>
                </div>

                <!-- ì‹ ê³¡ ì„¹ì…˜ -->
                <div class="bg-blue-50 rounded-xl p-3 border border-blue-100">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-[#005ED2]/20 text-[#005ED2] text-[10px] font-bold px-1.5 py-0.5 rounded">NEW</span>
                        <span class="text-xs font-bold text-gray-700">ì‹ ê³¡ ë°œë§¤</span>
                    </div>
                    <!-- ID ì¶”ê°€: new-song-content -->
                    <p id="new-song-content" class="text-xs text-gray-500 leading-relaxed pl-1">ğŸ”¥ <strong>4ê³¡</strong> ì‹ ê·œ ë“±ë¡ ğŸ”¥<br>'ë˜¥ì„ ì‹¸ê³  ì†ì„ ì”»ì', 'ë¯¸ì¹œ ë°¤'<br>'ìš°ë¦¬ëŠ” ì—”ì¡°ì´', 'ë„ˆì˜ ì„¸ìƒ'</p>
                </div>
            </div>

            <div class="p-5 pt-0">
                <button id="notice-close" class="w-full bg-[#005ED2] text-white font-bold py-3 rounded-xl hover:bg-[#004bb5] transition-colors shadow-lg shadow-[#005ED2]/30 text-sm">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Coming Soon íŒì—… -->
    <div id="popup-modal" class="fixed inset-0 z-[60] bg-black/30 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl border border-gray-100 scale-in">
            <div class="w-12 h-12 bg-[#005ED2]/10 rounded-full flex items-center justify-center mx-auto mb-4 text-[#005ED2]">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            </div>
            <h3 class="text-lg font-bold text-black mb-2">Coming Soon</h3>
            <p class="text-gray-500 text-sm mb-6">ì´ ê³¡ì€ ê³§ ê³µê°œë  ì˜ˆì •ì…ë‹ˆë‹¤.<br>ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p>
            <button id="popup-close" class="w-full bg-gray-900 text-white font-bold py-3 rounded-xl hover:bg-gray-800 transition-colors">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì•„í‹°ìŠ¤íŠ¸ ë…¸ë˜ ëª©ë¡ ëª¨ë‹¬ -->
    <div id="artist-modal" class="fixed inset-0 z-[80] bg-black/50 backdrop-blur-sm hidden flex items-end sm:items-center justify-center transition-opacity duration-300">
        <div class="bg-white w-full sm:max-w-sm sm:rounded-2xl rounded-t-2xl p-6 pb-10 shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform transition-transform duration-300 translate-y-full" id="artist-modal-content">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
            <div class="flex items-center gap-4 mb-6">
                <div class="w-16 h-16 rounded-full overflow-hidden shadow-md border border-gray-100 flex items-center justify-center bg-gray-50 relative">
                    <!-- ì•„ì´ì½˜ (ê¸°ë³¸) -->
                    <svg id="artist-modal-icon" width="40" height="40" viewBox="0 0 24 24" fill="currentColor" class="text-gray-400 absolute">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <!-- ì´ë¯¸ì§€ (OSTìš©) -->
                    <img id="artist-modal-img" src="" class="w-full h-full object-cover absolute hidden">
                </div>
                <div>
                    <h3 id="artist-modal-name" class="text-xl font-bold text-black">Artist Name</h3>
                    <p class="text-xs text-gray-500 mt-1">ë…¸ë˜ ëª©ë¡</p>
                </div>
            </div>
            <div id="artist-song-list" class="flex flex-col gap-1 max-h-[50vh] overflow-y-auto scrollbar-hide">
                <!-- ë…¸ë˜ ë¦¬ìŠ¤íŠ¸ ë“¤ì–´ê°ˆ ê³³ -->
            </div>
            <button id="artist-modal-close" class="w-full bg-gray-100 text-black font-bold py-3 rounded-xl mt-6 hover:bg-gray-200 transition-colors">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="admin-login-modal" class="fixed inset-0 z-[90] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs text-center shadow-2xl scale-in">
            <h3 class="text-lg font-bold text-black mb-4">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <input type="password" id="admin-pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full bg-gray-100 rounded-xl px-4 py-3 mb-4 text-center focus:outline-none focus:ring-2 focus:ring-[#005ED2]">
            <div class="flex gap-2">
                <button id="admin-login-cancel" class="flex-1 bg-gray-200 text-gray-600 font-bold py-3 rounded-xl">ì·¨ì†Œ</button>
                <button id="admin-login-submit" class="flex-1 bg-[#005ED2] text-white font-bold py-3 rounded-xl">ë¡œê·¸ì¸</button>
            </div>
        </div>
    </div>
    
    <!-- ê´€ë¦¬ì ê³µì§€ ìˆ˜ì • ëª¨ë‹¬ (ì…ë ¥ í•„ë“œ ë¶„ë¦¬) -->
    <div id="admin-edit-modal" class="fixed inset-0 z-[95] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl scale-in max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-black mb-4 text-center">ê³µì§€ì‚¬í•­ ìˆ˜ì •</h3>
            
            <label class="block text-xs font-bold text-gray-500 mb-1">ì—…ë°ì´íŠ¸ ë‚´ìš©</label>
            <textarea id="edit-update-content" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 mb-3 h-20 text-xs resize-none focus:outline-none focus:border-[#005ED2] font-mono leading-relaxed"></textarea>
            
            <label class="block text-xs font-bold text-gray-500 mb-1">ì‹ ê³¡ ì•ˆë‚´</label>
            <textarea id="edit-new-song-content" class="w-full bg-blue-50 border border-blue-100 rounded-lg px-3 py-2 mb-4 h-20 text-xs resize-none focus:outline-none focus:border-[#005ED2] font-mono leading-relaxed"></textarea>
            
            <div class="flex gap-2">
                <button id="admin-edit-cancel" class="flex-1 bg-gray-200 text-gray-600 font-bold py-3 rounded-xl">ì·¨ì†Œ</button>
                <button id="admin-edit-save" class="flex-1 bg-[#005ED2] text-white font-bold py-3 rounded-xl">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì „ì²´ ì°¨íŠ¸ ë·° -->
    <div id="full-chart-view" class="fixed inset-0 z-[80] bg-white transform translate-x-full transition-transform duration-300 flex flex-col h-[100dvh]">
        <div class="px-6 pt-8 pb-4 flex items-center gap-4 bg-white/95 backdrop-blur-md sticky top-0 z-10 border-b border-gray-100">
            <button id="btn-close-chart" class="p-2 -ml-2 rounded-full text-black hover:bg-gray-100 transition-colors">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <h2 class="text-xl font-bold text-black">ì—”ì¡°ì´ ì°¨íŠ¸ TOP 100</h2>
        </div>
        <div id="full-chart-list" class="flex-1 overflow-y-auto px-0 pb-32"></div>
    </div>

    <!-- 1. í™ˆ í™”ë©´ -->
    <div id="home-screen" class="relative z-10 h-full flex flex-col opacity-0 transition-opacity duration-1000">
        <div class="px-6 pt-8 pb-4 flex justify-between items-center">
            <div class="flex items-center gap-2"> 
                <div class="text-[#005ED2] flex items-center justify-center">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 10v4"></path><path d="M9 7v10"></path><path d="M13 4v16"></path><path d="M17 8v8"></path><path d="M21 11v2"></path></svg>
                </div>
                <h1 class="font-logo tracking-tight text-black text-2xl lowercase pt-1">Play enjoy</h1>
            </div>
            <div class="flex items-center gap-2">
                 <button id="btn-admin-login" class="p-2 rounded-full text-gray-400 hover:text-[#005ED2] hover:bg-gray-100 transition-colors">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </button>
                <a href="https://won429.github.io/enjoysite/" class="p-2 rounded-full text-gray-400 hover:text-[#005ED2] hover:bg-gray-100 transition-colors">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </a>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto scrollbar-hide pb-32">
            <!-- New Album -->
            <div class="mb-8 pl-6">
                <p class="text-sm text-[#005ED2] font-bold mb-4">New Album</p>
                <div class="flex gap-4 overflow-x-auto scrollbar-hide pr-6" id="new-album-list"></div>
            </div>
            
            <!-- Chart -->
            <div class="mb-10">
                <div class="flex justify-between items-center mb-4 px-6">
                    <div class="flex items-center gap-2">
                        <h3 class="text-lg font-bold text-black">ì—”ì¡°ì´ ì°¨íŠ¸</h3>
                        <span id="chart-time" class="text-xs text-gray-400 font-medium pt-1"></span>
                        <button id="btn-play-all" class="text-[11px] text-[#005ED2] hover:text-white hover:bg-[#005ED2] border border-[#005ED2]/30 font-bold flex items-center gap-1 transition-colors px-2 py-1 rounded-full bg-[#005ED2]/5 ml-1">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            ëª¨ë‘ ì¬ìƒ
                        </button>
                    </div>
                    <button id="btn-more-chart" class="text-xs text-gray-400 hover:text-black font-medium flex items-center gap-1">
                        ë”ë³´ê¸° <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                </div>
                <div id="chart-slider" class="flex overflow-x-auto snap-x snap-mandatory scrollbar-hide px-6 gap-4"></div>
            </div>

            <!-- Artists Section (OST í¬í•¨, ì•„ì´ì½˜/ì´ë¯¸ì§€ êµ¬ë¶„) -->
            <div class="pl-6 mb-8">
                <p class="text-sm text-[#005ED2] font-bold mb-4">Artists</p>
                <div class="flex gap-5 overflow-x-auto scrollbar-hide pr-6" id="artist-list">
                    <!-- ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë Œë”ë§ -->
                </div>
            </div>

            <!-- Coming Soon -->
            <div class="pl-6 mb-8">
                <p class="text-sm text-[#005ED2] font-bold mb-4">Coming Soon</p>
                <div class="flex gap-4 overflow-x-auto scrollbar-hide pr-6" id="coming-soon-list"></div>
            </div>
        </div>

        <!-- Mini Player -->
        <div id="mini-player" class="absolute bottom-0 left-0 right-0 bg-[#1E1E1E] border-t border-white/5 px-4 pt-3 pb-safe cursor-pointer translate-y-full transition-transform duration-300 z-20 shadow-[0_-10px_30px_rgba(0,0,0,0.1)]">
            <div class="flex items-center justify-between mb-1 pointer-events-none"> 
                <div class="flex items-center gap-3">
                    <div class="w-11 h-11 rounded-lg overflow-hidden bg-gray-800 relative shadow-inner">
                        <img id="mini-cover" src="./cover.jpg" class="w-full h-full object-cover">
                    </div>
                    <div class="flex flex-col justify-center">
                        <h4 id="mini-title" class="text-sm font-bold text-white truncate max-w-[150px]">ë¹›</h4>
                        <p id="mini-artist" class="text-xs text-gray-400 truncate">ì—”ìª½ì´ OST Part.2</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 pr-2 pointer-events-auto"> 
                    <button id="mini-play-btn" class="w-9 h-9 flex items-center justify-center bg-white text-black rounded-full shadow-md active:scale-90 transition-transform">
                        <svg id="mini-icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <svg id="mini-icon-pause" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                </div>
            </div>
            <div class="absolute top-0 left-0 right-0 h-[2px] bg-white/10">
                <div id="mini-progress" class="h-full bg-[#005ED2] w-0 transition-all duration-300"></div>
            </div>
        </div>
    </div>

    <!-- 2. ì „ì²´ í”Œë ˆì´ì–´ í™”ë©´ -->
    <div id="player-screen" class="fixed inset-0 z-50 bg-[#0a0a0a] transform translate-y-full transition-transform duration-500 flex flex-col h-[100dvh]">
        <div class="absolute inset-0 z-0 pointer-events-none overflow-hidden">
             <img id="player-bg-image" src="./cover.jpg" class="w-full h-full object-cover blur-3xl scale-150 brightness-50">
             <div class="absolute inset-0 bg-black/30"></div>
             <div class="bg-noise"></div>
        </div>
        <div class="relative z-10 flex justify-between items-center p-6 pt-10">
            <button id="btn-minimize" class="p-2 rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-all">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </button>
            <span class="text-[10px] font-bold tracking-[0.2em] text-white/50">NOW PLAYING</span>
            <button class="p-2 rounded-full text-white/70 hover:text-white hover:bg-white/10 transition-all">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
            </button>
        </div>
        <div class="relative z-10 flex-1 flex flex-col items-center justify-center px-8 pb-8 text-white">
             <div id="error-box" class="hidden bg-red-500/90 text-white text-xs p-3 rounded-xl mb-8 text-center animate-pulse w-full max-w-xs">
                <p>íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="mt-1 opacity-75 text-[10px]">music.mp3 í™•ì¸ í•„ìš”</p>
            </div>
            
            <!-- ê°€ì‚¬ ì˜¤ë²„ë ˆì´ -->
            <div id="lyrics-overlay" class="fixed inset-0 flex flex-col lyrics-closed">
                 <!-- ë°°ê²½ -->
                 <div class="absolute inset-0 z-0">
                     <img id="lyrics-bg-image" src="./cover.jpg" class="w-full h-full object-cover blur-3xl scale-150 brightness-[0.4]">
                     <div class="absolute inset-0 bg-black/30 backdrop-blur-xl"></div>
                 </div>

                 <!-- ê°€ì‚¬ í™”ë©´ ìƒë‹¨ -->
                 <div class="relative z-10 flex justify-between items-center p-6 pt-10">
                     <div class="w-10"></div> 
                     <span class="text-[10px] font-bold tracking-[0.2em] text-white/50">LYRICS</span>
                     <!-- ê°€ì‚¬ ë‚´ë¦¬ê¸° ë²„íŠ¼ -->
                     <button id="btn-close-lyrics" class="w-10 h-10 flex items-center justify-center text-white/70 hover:text-white bg-white/10 hover:bg-white/20 rounded-full transition-all backdrop-blur-sm shadow-lg active:scale-95">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                     </button>
                 </div>
                 
                 <div class="relative z-10 flex-1 overflow-hidden w-full">
                     <div id="lyrics-content" class="w-full h-full overflow-y-auto scrollbar-hide font-lyrics px-8 pb-40 text-left pt-24 lyrics-mask">
                         <p class="text-white/50 text-sm font-medium animate-pulse">ê°€ì‚¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                     </div>
                 </div>
            </div>

            <div class="relative w-full max-w-[320px] aspect-square mb-auto mt-4 group">
                <div id="tone-arm" class="absolute -top-8 -right-4 w-24 h-48 z-20 origin-[70%_15%] transition-transform duration-700 ease-in-out" style="transform: rotate(-25deg);">
                    <svg viewBox="0 0 100 200" class="w-full h-full drop-shadow-2xl">
                        <circle cx="70" cy="30" r="12" fill="#444" stroke="#222" stroke-width="2" /><circle cx="70" cy="30" r="5" fill="#111" /><path d="M70 30 L60 160" stroke="#888" stroke-width="6" stroke-linecap="round" /><rect x="50" y="155" width="20" height="30" rx="4" fill="#333" transform="rotate(10 60 170)" /><path d="M58 180 L56 190" stroke="#aaa" stroke-width="2" />
                    </svg>
                </div>
                <div id="lp-disk" class="w-full h-full rounded-full shadow-[0_30px_60px_-12px_rgba(0,0,0,0.8)] border-[4px] border-[#1a1a1a] relative bg-[#111] overflow-hidden ring-1 ring-white/10 lp-animation lp-texture">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[60%] h-[60%] rounded-full overflow-hidden border-4 border-[#222] z-10 bg-gray-800">
                        <img id="cover-image" src="./cover.jpg" class="w-full h-full object-cover opacity-90">
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent pointer-events-none rounded-full"></div>
                </div>
            </div>
            <div class="w-full mb-8 flex items-end justify-between">
                <div class="flex-1 min-w-0 mr-4">
                    <h2 id="song-title" class="text-2xl font-bold text-white mb-1 truncate scroll-m-0 tracking-tight">ë¹›</h2>
                    <p id="song-artist" class="text-white/60 text-base font-medium truncate">ì—”ìª½ì´ OST Part.2</p>
                </div>
                <!-- ê°€ì‚¬ ë²„íŠ¼ -->
                <button id="btn-lyrics" class="text-white/40 hover:text-[#005ED2] transition-all transform active:scale-90 p-2 relative group">
                    <div class="absolute inset-0 bg-[#005ED2]/20 rounded-full scale-0 group-hover:scale-150 transition-transform duration-300"></div>
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="relative z-10">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </button>
            </div>
            <div class="w-full mb-1 relative h-10 flex items-center justify-center" id="progress-container">
                <div class="absolute left-0 right-0 h-1 bg-white/10 rounded-full overflow-hidden pointer-events-none">
                    <div id="progress-fill" class="absolute top-0 left-0 h-full bg-white rounded-full smooth-transition group-hover:bg-[#005ED2]" style="width: 0%"></div>
                </div>
                <div id="progress-handle" class="absolute h-3 w-3 bg-white rounded-full opacity-0 group-hover:opacity-100 smooth-transition pointer-events-none left-0 -ml-[6px]"></div>
                <input type="range" id="seek-slider" min="0" max="100" step="0.1" value="0" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-30" style="touch-action: none;">
            </div>
            <div class="w-full flex justify-between text-[10px] text-white/60 font-mono font-medium tracking-wider">
                <span id="player-time-current">00:00</span>
                <span id="player-time-duration">00:00</span>
            </div>
            <div class="mt-auto w-full flex justify-between items-center px-4 pb-safe pt-2">
                <button class="text-white/30 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-full">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                </button>
                <div class="flex items-center gap-6">
                    <button id="btn-prev" class="text-white hover:text-[#005ED2] active:scale-90 transition-all p-2">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
                    </button>
                    <button id="btn-play" class="w-16 h-16 flex items-center justify-center bg-white text-black rounded-full shadow-[0_0_30px_rgba(255,255,255,0.15)] hover:scale-105 hover:bg-[#005ED2] hover:text-white hover:shadow-[0_0_40px_rgba(0,94,210,0.5)] active:scale-95 transition-all duration-300">
                        <svg id="icon-play" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <svg id="icon-pause" class.hidden" width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                    <button id="btn-next" class="text-white hover:text-[#005ED2] active:scale-90 transition-all p-2">
                         <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                    </button>
                </div>
                <button id="btn-repeat" class.text-white/30 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-full">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <audio id="audio" playsinline webkit-playsinline></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const yourFirebaseConfig = {
            apiKey: "AIzaSyC-ufNqntX7Yf3gbu11FNUgSRwWN2bfvWc",
            authDomain: "play-enjoy-music.firebaseapp.com",
            projectId: "play-enjoy-music",
            storageBucket: "play-enjoy-music.firebasestorage.app",
            messagingSenderId: "678631946072",
            appId: "1:678631946072:web:ee72c229360599aa00172d"
        };

        let firebaseConfig, appId;
        let app, auth, db;

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = typeof __firebase_config === 'string' ? JSON.parse(__firebase_config) : __firebase_config;
            } else {
                firebaseConfig = yourFirebaseConfig;
            }
            appId = (typeof __app_id !== 'undefined') ? __app_id : 'play-enjoy-music-app';
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) { console.error("Firebase init failed:", e); }

        // ê³ ì • ë‚ ì§œ ì‚¬ìš© (ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ë§¤ë²ˆ ìƒì„±í•˜ì§€ ì•ŠìŒ)
        // const today = new Date().toISOString().split('T')[0];
        
        // ğŸµ ë…¸ë˜ ë°ì´í„°
        let songs = [
            { id: 13, title: "ë˜¥ì„ ì‹¸ê³  ì†ì„ ì”»ì", artist: "ì—”ì¡°ì´", src: "./music7.mp3", cover: "./cover12.jpg", lrc: "./music7.lrc", playCount: 0, rankStatus: 'new', releaseDate: '2025-11-26' },
            { id: 14, title: "ë¯¸ì¹œ ë°¤", artist: "ì—”ì¡°ì´", src: "./music8.mp3", cover: "./cover13.jpg", lrc: "./music8.lrc", playCount: 0, rankStatus: 'new', releaseDate: '2025-11-26' },
            { id: 15, title: "ìš°ë¦¬ëŠ” ì—”ì¡°ì´", artist: "ì˜¤ìŠ¤í‹´", src: "./music9.mp3", cover: "./cover14.jpg", lrc: "./music9.lrc", playCount: 0, rankStatus: 'new', releaseDate: '2025-11-26' },
            { id: 16, title: "ë„ˆì˜ ì„¸ìƒ", artist: "ì „ì‹œê¸°", src: "./music10.mp3", cover: "./cover15.jpg", lrc: "./music10.lrc", playCount: 0, rankStatus: 'new', releaseDate: '2025-11-26' },
            { id: 1, title: "ë¹›", artist: "ì—”ìª½ì´ OST Part.2", src: "./music.mp3", cover: "./cover.jpg", lrc: "./music.lrc", playCount: 0, rankStatus: '-', releaseDate: "2024-01-01" }, 
            { id: 2, title: "í˜ë‚´ë¼", artist: "ì—”ìª½ì´ OST Part.1", src: "./music2.mp3", cover: "./cover.jpg", lrc: "./music2.lrc", playCount: 0, rankStatus: '-', releaseDate: "2024-01-01" }, 
            { id: 4, title: "ëì—†ëŠ” ì—¬ë¦„ë°¤", artist: "ê·¸ë‚ , ì—”ì¡°ì´ ì´ì•¼ê¸° OST", src: "./music4.mp3", cover: "./cover3.jpg", lrc: "./music4.lrc", playCount: 0, rankStatus: '-', releaseDate: "2024-01-01" }, 
            { id: 5, title: "í–‰ë³µì„ ê¿ˆê¾¸ë©° ìš¸ë‹¤", artist: "ì—”ì¡°ì´", src: "./music5.mp3", cover: "./cover4.jpg", lrc: "./music5.lrc", playCount: 0, rankStatus: '-', releaseDate: "2024-01-01" }, 
            { id: 6, title: "í„¸ì–´", artist: "ì—”ì¡°ì´", src: "./music6.mp3", cover: "./cover5.jpg", lrc: "./music6.lrc", playCount: 0, rankStatus: '-', releaseDate: "2024-01-01" }, 
            { id: 3, title: "ë¹µê¸€ë¹µê¸€ ë¹µê¸€ì†¡", artist: "ì„±ì‹¬ë‹¹", src: "./music3.mp3", cover: "./cover2.jpg", lrc: "./music3.lrc", playCount: 0, rankStatus: '-', releaseDate: "2024-01-01" } 
        ];

        // ğŸ‘¨â€ğŸ¤ ì•„í‹°ìŠ¤íŠ¸ ë°ì´í„° - OST í¬í•¨, íƒ€ì… êµ¬ë¶„
        const artists = [
            { name: "ì—”ì¡°ì´", type: 'icon' },
            { name: "ì˜¤ìŠ¤í‹´", type: 'icon' },
            { name: "ì „ì‹œê¸°", type: 'icon' },
            { name: "ì„±ì‹¬ë‹¹", type: 'icon' },
            { name: "ì—”ìª½ì´ OST", type: 'image', image: './cover.jpg' },
            { name: "ê·¸ë‚ , ì—”ì¡°ì´ ì´ì•¼ê¸° OST", type: 'image', image: './cover3.jpg' }
        ];

        let lastRanking = [];
        try {
            const saved = localStorage.getItem('last_ranking_ids');
            if (saved) lastRanking = JSON.parse(saved);
        } catch(e) {}

        let chartData = { lastUpdated: 0, currentRanking: [], prevRanking: [], playCounts: {} };
        try {
            const saved = localStorage.getItem('chart_snapshot_v2');
            if (saved) {
                const parsed = JSON.parse(saved);
                if (parsed.currentRanking && parsed.playCounts) chartData = parsed;
            }
        } catch(e) {}

        const comingSoonSongs = [
            { id: 12, title: "ë„ˆì˜ ëª¨ë“  ìˆœê°„", artist: "í˜„ì‹", cover: "./cover11.jpg" }, 
            { id: 9, title: "ì†Œì£¼í•œì”", artist: "ì´ìƒí›ˆ&ë¥˜ë˜ì™„", cover: "./cover8.jpg" },
            { id: 10, title: "ë…¸ë˜ë°©ì—ì„œ", artist: "í™ì¤€í˜¸", cover: "./cover9.jpg" },
            { id: 11, title: "ë‚˜íŒ”ë°”ì§€", artist: "ì´ìƒí›ˆ, ì´ì§„í˜¸, ë¥˜ë˜ì™„", cover: "./cover10.jpg" },
            { id: 7, title: "ë¯¸ì •", artist: "ì—”ì¡°ì´ ìˆ™ë ¤ ìº í”„ OST", cover: "./cover6.jpg" },
            { id: 8, title: "ë¯¸ì •", artist: "ì¶œì¥ì—”ì¡°ì´ OST", cover: "./cover7.jpg" }
        ];

        const DEFAULT_NOTICE = {
            update: "ğŸ“Š ì—”ì¡°ì´ ì°¨íŠ¸ ì§‘ê³„ ì‹œì‘!<br>(ë…¸ë˜ë¥¼ ì¬ìƒí•˜ë©´ ìˆœìœ„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤)",
            newSong: "ğŸ”¥ <strong>4ê³¡</strong> ì‹ ê·œ ë“±ë¡ ğŸ”¥<br>'ë˜¥ì„ ì‹¸ê³  ì†ì„ ì”»ì', 'ë¯¸ì¹œ ë°¤'<br>'ìš°ë¦¬ëŠ” ì—”ì¡°ì´', 'ë„ˆì˜ ì„¸ìƒ'"
        };

        let currentIdx = 0;
        let isPlaying = false;
        let isDragging = false; 
        let isLiked = false; 
        let isRepeat = false;
        let songStats = {};
        let unsubscribeSnapshot = null;
        let latestSongStats = {};
        
        let currentLyrics = [];
        let isLyricsOpen = false;

        const audio = document.getElementById('audio');
        const chartSlider = document.getElementById('chart-slider');
        const fullChartView = document.getElementById('full-chart-view');
        const fullChartList = document.getElementById('full-chart-list');
        const btnMoreChart = document.getElementById('btn-more-chart');
        const btnCloseChart = document.getElementById('btn-close-chart');
        const btnPlayAll = document.getElementById('btn-play-all'); 
        const newAlbumList = document.getElementById('new-album-list');
        const artistList = document.getElementById('artist-list');
        const artistModal = document.getElementById('artist-modal');
        const artistModalContent = document.getElementById('artist-modal-content');
        const artistModalClose = document.getElementById('artist-modal-close');
        const artistModalName = document.getElementById('artist-modal-name');
        const artistModalImg = document.getElementById('artist-modal-img');
        const artistModalIcon = document.getElementById('artist-modal-icon');
        const artistSongList = document.getElementById('artist-song-list');
        const comingSoonList = document.getElementById('coming-soon-list');
        const playerScreen = document.getElementById('player-screen');
        const miniPlayer = document.getElementById('mini-player');
        const miniPlayBtn = document.getElementById('mini-play-btn');
        const errorBox = document.getElementById('error-box');
        const bootScreen = document.getElementById('boot-screen');
        const homeScreen = document.getElementById('home-screen');
        const popupModal = document.getElementById('popup-modal');
        const popupClose = document.getElementById('popup-close');
        const noticeModal = document.getElementById('notice-modal');
        const noticeClose = document.getElementById('notice-close');
        const btnLyrics = document.getElementById('btn-lyrics'); 
        const btnCloseLyrics = document.getElementById('btn-close-lyrics'); 
        const toneArm = document.getElementById('tone-arm');
        const btnRepeat = document.getElementById('btn-repeat'); 
        const miniCover = document.getElementById('mini-cover');
        const miniTitle = document.getElementById('mini-title');
        const miniArtist = document.getElementById('mini-artist');
        const miniIconPlay = document.getElementById('mini-icon-play');
        const miniIconPause = document.getElementById('mini-icon-pause');
        const lpDisk = document.getElementById('lp-disk');
        const btnPlay = document.getElementById('btn-play');
        const iconPlay = document.getElementById('icon-play');
        const iconPause = document.getElementById('icon-pause');
        const progressFill = document.getElementById('progress-fill');
        const progressHandle = document.getElementById('progress-handle');
        const seekSlider = document.getElementById('seek-slider');
        const timeCurr = document.getElementById('player-time-current');
        const timeDur = document.getElementById('player-time-duration');
        const playerBgImage = document.getElementById('player-bg-image');
        const chartTime = document.getElementById('chart-time');
        const lyricsOverlay = document.getElementById('lyrics-overlay');
        const lyricsBgImage = document.getElementById('lyrics-bg-image');
        const lyricsContent = document.getElementById('lyrics-content');

        const btnAdminLogin = document.getElementById('btn-admin-login');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const adminPwInput = document.getElementById('admin-pw-input');
        const adminLoginCancel = document.getElementById('admin-login-cancel');
        const adminLoginSubmit = document.getElementById('admin-login-submit');
        const adminEditModal = document.getElementById('admin-edit-modal');
        // ê´€ë¦¬ì ëª¨ë‹¬ ID ìˆ˜ì •ë¨
        const editUpdateContent = document.getElementById('edit-update-content');
        const editNewSongContent = document.getElementById('edit-new-song-content');
        const adminEditCancel = document.getElementById('admin-edit-cancel');
        const adminEditSave = document.getElementById('admin-edit-save');

        let hasEntered = false;
        function enterHome() {
            if (hasEntered) return;
            hasEntered = true;
            bootScreen.classList.add('fade-out');
            homeScreen.classList.remove('opacity-0');
            setTimeout(() => noticeModal.classList.remove('hidden'), 500);
            updateChartTime();
        }
        setTimeout(enterHome, 3000);
        bootScreen.addEventListener('click', enterHome);

        // ... (ì°¨íŠ¸ ì‹œê°„ ì—…ë°ì´íŠ¸, íŒì—… ë‹«ê¸° ë“± ê¸°ì¡´ ì½”ë“œ) ...
        function updateChartTime() {
            const now = new Date();
            const hours = now.getHours();
            if (chartTime) chartTime.innerText = `${hours}ì‹œ ê¸°ì¤€`;
        }

        noticeClose.onclick = () => noticeModal.classList.add('hidden');
        noticeModal.onclick = (e) => { if (e.target === noticeModal) noticeModal.classList.add('hidden'); };
        popupClose.onclick = () => popupModal.classList.add('hidden');
        popupModal.onclick = (e) => { if (e.target === popupModal) popupModal.classList.add('hidden'); };

        // ... (ì•„í‹°ìŠ¤íŠ¸ ëª¨ë‹¬ ê´€ë ¨) ...
        artistModalClose.onclick = closeArtistModal;
        artistModal.onclick = (e) => { if (e.target === artistModal) closeArtistModal(); };

        function closeArtistModal() {
            artistModalContent.classList.add('translate-y-full');
            setTimeout(() => {
                artistModal.classList.add('hidden');
            }, 300);
        }

        function openArtistModal(artist) {
            artistModalName.innerText = artist.name;
            artistSongList.innerHTML = '';

            if (artist.type === 'image') {
                artistModalImg.src = artist.image;
                artistModalImg.classList.remove('hidden');
                artistModalIcon.classList.add('hidden');
            } else {
                artistModalImg.classList.add('hidden');
                artistModalIcon.classList.remove('hidden');
            }

            // í•´ë‹¹ ì•„í‹°ìŠ¤íŠ¸ ì´ë¦„ì´ í¬í•¨ëœ ë…¸ë˜ í•„í„°ë§ (includes ì‚¬ìš©)
            const artistSongs = songs.filter(s => {
                // 'ì—”ì¡°ì´' ê²€ìƒ‰ ì‹œ 'ëì—†ëŠ” ì—¬ë¦„ë°¤(ê·¸ë‚ , ì—”ì¡°ì´ ì´ì•¼ê¸° OST)' ë“±ì€ ì œì™¸
                // (ì‹¤ì œ 'ì—”ì¡°ì´'ë¼ëŠ” ê°€ìˆ˜ê°€ ë¶€ë¥¸ ê³¡ë§Œ í¬í•¨í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì²˜ëŸ¼ í•„í„°ë§)
                if (artist.name === 'ì—”ì¡°ì´') {
                     // 'ì—”ì¡°ì´'ë§Œ ì •í™•íˆ í¬í•¨í•˜ê±°ë‚˜, ë‹¤ë¥¸ ê°€ìˆ˜ê°€ ì„ì´ì§€ ì•Šì€ ìˆœìˆ˜ ì—”ì¡°ì´ ê³¡ë§Œ
                     // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ 'OST'ê°€ í¬í•¨ëœ ê²½ìš° ì œì™¸í•˜ëŠ” ë¡œì§ ì˜ˆì‹œ
                     // ë˜ëŠ” ë°ì´í„°ì— artistId ë“±ì„ ë¶€ì—¬í•˜ì—¬ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•¨
                     if (s.artist.includes('OST')) return false;
                }
                return s.artist.includes(artist.name);
            });
            
            if (artistSongs.length > 0) {
                artistSongs.forEach(song => {
                    const originalIndex = songs.findIndex(s => s.id === song.id);
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-3 rounded-xl hover:bg-gray-100 cursor-pointer transition-colors";
                    div.innerHTML = `
                        <div class="w-10 h-10 rounded-lg overflow-hidden bg-gray-200 flex-shrink-0">
                            <img src="${song.cover}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-bold text-gray-900 truncate">${song.title}</h4>
                            <p class="text-xs text-gray-500 truncate">${song.artist}</p>
                        </div>
                        <button class="text-[#005ED2]">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        </button>
                    `;
                    div.onclick = () => {
                        openPlayer(originalIndex);
                        closeArtistModal();
                    };
                    artistSongList.appendChild(div);
                });
            } else {
                artistSongList.innerHTML = '<p class="text-gray-400 text-center py-4 text-sm">ë“±ë¡ëœ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            artistModal.classList.remove('hidden');
            setTimeout(() => {
                artistModalContent.classList.remove('translate-y-full');
            }, 10);
        }

        // ... (ê´€ë¦¬ì ë¡œê·¸ì¸ ë¡œì§) ...
        btnAdminLogin.onclick = () => { adminPwInput.value = ""; adminLoginModal.classList.remove('hidden'); };
        adminLoginCancel.onclick = () => adminLoginModal.classList.add('hidden');
        adminLoginModal.onclick = (e) => { if (e.target === adminLoginModal) adminLoginModal.classList.add('hidden'); };
        adminLoginSubmit.onclick = () => {
            if (adminPwInput.value === '0920') {
                adminLoginModal.classList.add('hidden');
                openAdminEdit(); 
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            }
        };

        // ê´€ë¦¬ì ìˆ˜ì • ë¡œì§ (ìˆ˜ì •ë¨)
        async function openAdminEdit() {
            let currentNotice = DEFAULT_NOTICE;
            if (auth && db) {
                const noticeRef = doc(db, 'artifacts', appId, 'public', 'data', 'site_config', 'main_notice_v2'); // v2ë¡œ ë³€ê²½í•˜ì—¬ ìƒˆ êµ¬ì¡° ì €ì¥
                try {
                    const snap = await getDoc(noticeRef);
                    if (snap.exists()) currentNotice = snap.data();
                } catch (e) { console.error("Load notice fail:", e); }
            }
            // ì¤„ë°”ê¿ˆ ë¬¸ì ì²˜ë¦¬
            editUpdateContent.value = currentNotice.update.replace(/<br\s*\/?>/gi, "\n");
            editNewSongContent.value = currentNotice.newSong.replace(/<br\s*\/?>/gi, "\n");
            adminEditModal.classList.remove('hidden');
        }

        adminEditCancel.onclick = () => adminEditModal.classList.add('hidden');
        adminEditSave.onclick = async () => {
            const newUpdate = editUpdateContent.value.replace(/\n/g, "<br>");
            const newNewSong = editNewSongContent.value.replace(/\n/g, "<br>");
            
            if (!auth || !db) { alert("DB ì—°ê²° ì‹¤íŒ¨"); return; }
            const noticeRef = doc(db, 'artifacts', appId, 'public', 'data', 'site_config', 'main_notice_v2');
            try {
                await setDoc(noticeRef, { update: newUpdate, newSong: newNewSong }, { merge: true });
                alert("ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                adminEditModal.classList.add('hidden');
            } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
        };

        function setupNoticeListener() {
            if (!auth || !db) return;
            const noticeRef = doc(db, 'artifacts', appId, 'public', 'data', 'site_config', 'main_notice_v2');
            onSnapshot(noticeRef, (doc) => {
                const updateEl = document.getElementById('update-content');
                const newSongEl = document.getElementById('new-song-content');
                
                if (doc.exists()) {
                    const data = doc.data();
                    if (updateEl) updateEl.innerHTML = data.update;
                    if (newSongEl) newSongEl.innerHTML = data.newSong;
                } else {
                    if (updateEl) updateEl.innerHTML = DEFAULT_NOTICE.update;
                    if (newSongEl) newSongEl.innerHTML = DEFAULT_NOTICE.newSong;
                }
            });
        }

        // ... (ë‚˜ë¨¸ì§€ ë¯¸ë””ì–´ ì„¸ì…˜, ë­í‚¹, ë Œë”ë§ í•¨ìˆ˜ë“¤ ê¸°ì¡´ê³¼ ë™ì¼) ...
        function updateMediaSessionMetadata(song) {
            if ('mediaSession' in navigator) {
                try {
                    const getAbsoluteUrl = (url) => {
                        try { return new URL(url, document.baseURI).href; } catch(e) { return url; }
                    };
                    const artworkSrc = getAbsoluteUrl(song.cover);
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: song.title,
                        artist: song.artist,
                        album: "Play enjoy Album",
                        artwork: [
                            { src: artworkSrc, sizes: '96x96', type: 'image/jpeg' },
                            { src: artworkSrc, sizes: '128x128', type: 'image/jpeg' },
                            { src: artworkSrc, sizes: '192x192', type: 'image/jpeg' },
                            { src: artworkSrc, sizes: '256x256', type: 'image/jpeg' },
                            { src: artworkSrc, sizes: '384x384', type: 'image/jpeg' },
                            { src: artworkSrc, sizes: '512x512', type: 'image/jpeg' },
                        ]
                    });
                } catch (e) {
                    console.warn("Media Session update failed:", e);
                }
            }
        }

        function setupMediaSessionActionHandlers() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', () => togglePlay(true));
                navigator.mediaSession.setActionHandler('pause', () => togglePlay(false));
                navigator.mediaSession.setActionHandler('previoustrack', () => {
                     let prevIdx = currentIdx - 1;
                     if (prevIdx < 0) prevIdx = songs.length - 1;
                     openPlayer(prevIdx);
                });
                navigator.mediaSession.setActionHandler('nexttrack', () => {
                    let nextIdx = currentIdx + 1;
                    if (nextIdx >= songs.length) nextIdx = 0;
                    openPlayer(nextIdx);
                });
            }
        }
        setupMediaSessionActionHandlers();

        function setupRealtimeListener() {
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            const safeAppId = appId || 'default-app-id';
            const statsRef = collection(db, 'artifacts', safeAppId, 'public', 'data', 'song_stats');
            unsubscribeSnapshot = onSnapshot(statsRef, (snapshot) => {
                latestSongStats = {};
                snapshot.forEach(doc => { latestSongStats[doc.id] = doc.data().count || 0; });
                updateRankings();
            }, (error) => {
                console.warn("Snapshot error:", error);
                renderAll();
            });
        }

        function updateRankings() {
            const now = new Date();
            const currentHour = now.getHours();
            const lastUpdateDate = new Date(chartData.lastUpdated || 0);
            const lastUpdateHour = lastUpdateDate.getHours();
            const needsUpdate = now.getDate() !== lastUpdateDate.getDate() || currentHour !== lastUpdateHour || chartData.currentRanking.length === 0;

            if (needsUpdate) {
                const tempSongs = [...songs];
                tempSongs.forEach(s => { s.playCount = latestSongStats[s.id] || 0; });
                tempSongs.sort((a, b) => {
                    if (b.playCount !== a.playCount) return b.playCount - a.playCount;
                    return a.id - b.id;
                });
                const newRankingIds = tempSongs.map(s => s.id);
                const newPlayCounts = {};
                tempSongs.forEach(s => newPlayCounts[s.id] = s.playCount);

                chartData.prevRanking = chartData.currentRanking;
                chartData.currentRanking = newRankingIds;
                chartData.playCounts = newPlayCounts;
                chartData.lastUpdated = now.getTime();
                localStorage.setItem('chart_snapshot_v2', JSON.stringify(chartData));
            }

            const orderedSongs = [];
            chartData.currentRanking.forEach(id => {
                const song = songs.find(s => s.id === id);
                if (song) orderedSongs.push(song);
            });
            songs.forEach(s => {
                if (!chartData.currentRanking.includes(s.id)) orderedSongs.push(s);
            });
            songs = orderedSongs;

            const ONE_DAY = 24 * 3600 * 1000;
            songs.forEach((song, index) => {
                song.playCount = chartData.playCounts[song.id] || 0;
                const releaseTime = new Date(song.releaseDate).getTime();
                song.isNew = (Date.now() - releaseTime) < ONE_DAY;
                let change = '-';
                if (chartData.prevRanking.length > 0) {
                    const oldIndex = chartData.prevRanking.indexOf(song.id);
                    if (oldIndex === -1) change = 'new'; 
                    else {
                        if (index < oldIndex) change = 'up';
                        else if (index > oldIndex) change = 'down';
                    }
                }
                song.rankChange = change;
            });

            if(chartTime) chartTime.innerText = `${new Date(chartData.lastUpdated).getHours()}ì‹œ ê¸°ì¤€`;
            renderAll();
        }

        async function incrementPlayCount(songId) {
            if (!auth || !auth.currentUser) return;
            const safeAppId = appId || 'default-app-id';
            const docRef = doc(db, 'artifacts', safeAppId, 'public', 'data', 'song_stats', String(songId));
            try { await setDoc(docRef, { count: increment(1) }, { merge: true }); } catch (e) { console.error("Inc failed", e); }
        }

        function getRankHTML(song) {
            let html = '';
            if (song.isNew) html += `<span class="text-yellow-500 text-[8px] font-bold tracking-tighter mb-0.5">NEW</span>`;
            if (song.rankChange === 'up') html += `<span class="text-red-500 text-[10px] font-bold flex items-center justify-center">â–²</span>`;
            else if (song.rankChange === 'down') html += `<span class="text-blue-500 text-[10px] font-bold flex items-center justify-center">â–¼</span>`;
            else if (!song.isNew) html += `<span class="text-gray-400 text-[10px] flex items-center justify-center">-</span>`;
            return html;
        }

        function renderAll() {
            renderNewAlbumList();
            renderChartList();
            renderFullChartList();
            renderComingSoonList();
            renderArtistList();
        }

        function renderNewAlbumList() {
            newAlbumList.innerHTML = '';
            const sortedByNewest = [...songs].sort((a, b) => b.id - a.id); 
            sortedByNewest.forEach((song) => {
                const originalIndex = songs.findIndex(s => s.id === song.id);
                const div = document.createElement('div');
                div.className = "flex-shrink-0 w-40 group cursor-pointer";
                div.innerHTML = `
                    <div class="w-40 h-40 rounded-2xl overflow-hidden bg-gray-800 mb-3 shadow-lg relative">
                        <img src="${song.cover}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.style.display='none'">
                        <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center border border-white/30">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-base font-bold text-black truncate">${song.title}</h3>
                    <p class="text-xs text-gray-500 truncate font-medium">${song.artist}</p>
                    <div class="mt-3 inline-flex items-center gap-2 bg-[#005ED2] text-white px-3 py-1.5 rounded-full font-bold text-xs hover:bg-[#005ED2]/80 transition-colors shadow-lg shadow-[#005ED2]/20">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        Play Now
                    </div>
                `;
                div.addEventListener('click', () => openPlayer(originalIndex));
                newAlbumList.appendChild(div);
            });
        }

        function renderChartList() {
            chartSlider.innerHTML = '';
            const chunkSize = 3;
            for (let i = 0; i < songs.length; i += chunkSize) {
                const chunk = songs.slice(i, i + chunkSize);
                const slide = document.createElement('div');
                slide.className = "min-w-[90%] snap-start flex flex-col gap-1"; 
                chunk.forEach((song, idx) => {
                    const realIndex = i + idx;
                    const rank = realIndex + 1;
                    const rankColorClass = rank <= 3 ? "text-[#005ED2]" : "text-gray-800";
                    const item = document.createElement('div');
                    item.className = "flex items-center gap-4 p-3 rounded-xl hover:bg-gray-100 active:scale-98 transition-all cursor-pointer group";
                    item.innerHTML = `
                        <div class="flex flex-col items-center justify-center w-8 mr-1">
                            <span class="${rankColorClass} text-lg font-bold font-logo leading-none mb-1">${rank}</span>
                            <div class="flex flex-col items-center gap-0.5">${getRankHTML(song)}</div>
                        </div>
                        <div class="w-12 h-12 rounded-lg bg-gray-800 overflow-hidden relative flex-shrink-0">
                            <img src="${song.cover}" class="w-full h-full object-cover" onerror="this.style.opacity='0.5'">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base font-medium text-black truncate">${song.title}</h3>
                            <p class="text-xs text-gray-500 truncate">${song.artist}</p>
                            <p class="text-[10px] text-gray-400 mt-0.5">ì¬ìƒ ${song.playCount}íšŒ</p>
                        </div>
                        <button class="text-gray-400 hover:text-black">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                        </button>
                    `;
                    item.addEventListener('click', () => openPlayer(realIndex));
                    slide.appendChild(item);
                });
                chartSlider.appendChild(slide);
            }
        }

        function renderFullChartList() {
            fullChartList.innerHTML = '';
            songs.forEach((song, index) => {
                const rank = index + 1;
                const rankColorClass = rank <= 3 ? "text-[#005ED2]" : "text-gray-800";
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 border-b border-gray-100 hover:bg-gray-50 active:scale-[0.99] transition-all cursor-pointer";
                div.innerHTML = `
                    <div class="flex flex-col items-center justify-center w-8 mr-2 flex-shrink-0">
                        <span class="${rankColorClass} text-lg font-bold font-logo leading-none mb-0.5">${rank}</span>
                        <div class="flex flex-col items-center gap-0.5 scale-90">${getRankHTML(song)}</div>
                    </div>
                    <div class="w-12 h-12 rounded-lg bg-gray-800 overflow-hidden relative flex-shrink-0 shadow-sm">
                        <img src="${song.cover}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <h3 class="text-sm font-bold text-black leading-tight break-keep mb-0.5">${song.title}</h3>
                        <p class="text-xs text-gray-500 break-keep">${song.artist}</p>
                        <p class="text-[9px] text-[#005ED2] mt-0.5 font-medium bg-[#005ED2]/5 inline-block px-1.5 py-0.5 rounded-full w-fit">${song.playCount}íšŒ ì¬ìƒ</p>
                    </div>
                    <button class="p-2 text-gray-400 hover:text-black flex-shrink-0">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                    </button>
                `;
                div.addEventListener('click', () => {
                    openPlayer(index);
                    fullChartView.classList.add('translate-x-full');
                });
                fullChartList.appendChild(div);
            });
        }

        function renderComingSoonList() {
            comingSoonList.innerHTML = '';
            comingSoonSongs.forEach((song) => {
                const div = document.createElement('div');
                div.className = "flex-shrink-0 w-32 group cursor-pointer";
                div.innerHTML = `
                    <div class="w-32 h-32 rounded-xl overflow-hidden bg-gray-800 mb-2 shadow-lg relative">
                        <img src="${song.cover}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" onerror="this.style.display='none'">
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="w-8 h-8 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                            </div>
                        </div>
                    </div>
                    <h3 class="text-sm font-bold text-black truncate">${song.title}</h3>
                    <p class="text-[10px] text-gray-500 truncate font-medium">${song.artist}</p>
                `;
                div.addEventListener('click', () => popupModal.classList.remove('hidden'));
                comingSoonList.appendChild(div);
            });
        }

        function renderArtistList() {
            artistList.innerHTML = '';
            artists.forEach(artist => {
                const div = document.createElement('div');
                div.className = "flex-shrink-0 flex flex-col items-center cursor-pointer group w-20";
                
                let innerContent = '';
                if (artist.type === 'image') {
                     innerContent = `<img src="${artist.image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">`;
                } else {
                     innerContent = `<svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor" class="text-gray-400 group-hover:text-[#005ED2] transition-colors"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                }

                div.innerHTML = `
                    <div class="w-20 h-20 rounded-full overflow-hidden border-2 border-transparent group-hover:border-[#005ED2] transition-colors shadow-md mb-2 bg-gray-50 flex items-center justify-center">
                        ${innerContent}
                    </div>
                    <span class="text-xs font-bold text-black group-hover:text-[#005ED2] transition-colors text-center w-full break-keep leading-tight line-clamp-2 px-1">${artist.name}</span>
                `;
                div.onclick = () => openArtistModal(artist);
                artistList.appendChild(div);
            });
        }

        async function fetchLrc(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) return null;
                const text = await response.text();
                return parseLrc(text);
            } catch (e) {
                return null;
            }
        }

        function parseLrc(lrcText) {
            const lines = lrcText.split('\n');
            const result = [];
            const timeReg = /\[(\d{2}):(\d{2})[.:](\d{2,3})\]/;
            
            lines.forEach(line => {
                const match = timeReg.exec(line);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    let ms = parseInt(match[3]);
                    if (match[3].length === 3) ms = ms / 10; // 3ìë¦¬ ë°€ë¦¬ì´ˆ ëŒ€ì‘
                    const time = min * 60 + sec + ms / 100;
                    const text = line.replace(timeReg, '').trim();
                    if (text) result.push({ time, text });
                }
            });
            return result;
        }

        // íŠ¹ì • ê°€ì‚¬ ìœ„ì¹˜ë¡œ ì¦‰ì‹œ ìŠ¤í¬ë¡¤ (ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ - ì´ˆê¸° ë¡œë”©ìš©)
        function scrollToActiveLyricImmediate() {
            if (!isLyricsOpen || currentLyrics.length === 0) return;
            const currentTime = audio.currentTime;
            let activeIdx = -1;
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentTime >= currentLyrics[i].time) activeIdx = i;
                else break;
            }
            if (activeIdx === -1) activeIdx = 0; 

            const lines = lyricsContent.getElementsByClassName('lyric-line');
            if (lines[activeIdx]) {
                // ìƒë‹¨ 15% ì§€ì  (ë” ìœ„ìª½)ì— ìœ„ì¹˜í•˜ë„ë¡ ê³„ì‚°
                const offset = lines[activeIdx].offsetTop - (lyricsContent.clientHeight * 0.15);
                lyricsContent.scrollTo({ top: offset, behavior: 'auto' });
                
                for (let i = 0; i < lines.length; i++) {
                    if (i === activeIdx) lines[i].classList.add('active');
                    else lines[i].classList.remove('active');
                }
            }
        }

        function syncLyrics() {
            if (!isLyricsOpen || currentLyrics.length === 0) return;
            const currentTime = audio.currentTime;
            
            let activeIdx = -1;
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentTime >= currentLyrics[i].time) {
                    activeIdx = i;
                } else {
                    break;
                }
            }
            
            const lines = lyricsContent.getElementsByClassName('lyric-line');
            for (let i = 0; i < lines.length; i++) {
                if (i === activeIdx) {
                    if (!lines[i].classList.contains('active')) {
                        lines[i].classList.add('active');
                        // í™œì„±í™” ì‹œ ìƒë‹¨ 15% ì§€ì ì— ì˜¤ë„ë¡ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
                        const offset = lines[i].offsetTop - (lyricsContent.clientHeight * 0.15);
                        lyricsContent.scrollTo({ top: offset, behavior: 'smooth' });
                    }
                } else {
                    lines[i].classList.remove('active');
                }
            }
        }
        
        if(btnLyrics) {
            btnLyrics.addEventListener('click', () => {
                if (!isLyricsOpen) {
                    isLyricsOpen = true;
                    lyricsOverlay.classList.remove('lyrics-closed');
                    lyricsOverlay.classList.add('lyrics-open');
                    btnLyrics.classList.remove('text-white/40');
                    btnLyrics.classList.add('text-[#005ED2]');
                    
                    scrollToActiveLyricImmediate();
                } else {
                    isLyricsOpen = false;
                    lyricsOverlay.classList.remove('lyrics-open');
                    lyricsOverlay.classList.add('lyrics-closed');
                    btnLyrics.classList.add('text-white/40');
                    btnLyrics.classList.remove('text-[#005ED2]');
                }
            });
        }

        // ë‹«ê¸° ë²„íŠ¼ ë¡œì§ ì¶”ê°€
        if (btnCloseLyrics) {
            btnCloseLyrics.addEventListener('click', () => {
                isLyricsOpen = false;
                lyricsOverlay.classList.remove('lyrics-open');
                lyricsOverlay.classList.add('lyrics-closed');
                btnLyrics.classList.add('text-white/40');
                btnLyrics.classList.remove('text-[#005ED2]');
            });
        }

        const loadSongData = async (index) => {
            const song = songs[index];
            if (!song) return;
            audio.src = song.src;
            audio.dataset.songId = song.id; 
            document.getElementById('song-title').innerText = song.title;
            document.getElementById('song-artist').innerText = song.artist;
            document.getElementById('cover-image').src = song.cover;
            playerBgImage.src = song.cover;
            
            if(lyricsBgImage) lyricsBgImage.src = song.cover;

            miniTitle.innerText = song.title;
            miniArtist.innerText = song.artist;
            miniCover.src = song.cover;
            errorBox.classList.add('hidden');
            timeCurr.innerText = "00:00";
            timeDur.innerText = "00:00";
            
            updateMediaSessionMetadata(song);
            
            currentLyrics = [];
            lyricsContent.innerHTML = '<p class="text-white/50 text-sm mt-20 font-medium animate-pulse">ê°€ì‚¬ ë¡œë”© ì¤‘...</p>';
            
            if (song.lrc) {
                const parsed = await fetchLrc(song.lrc);
                if (parsed && parsed.length > 0) {
                    currentLyrics = parsed;
                    lyricsContent.innerHTML = parsed.map(line => `<p class="lyric-line py-2 cursor-pointer hover:text-white transition-colors">${line.text}</p>`).join('');
                    
                    const lineElements = lyricsContent.getElementsByClassName('lyric-line');
                    Array.from(lineElements).forEach((el, idx) => {
                        el.addEventListener('click', () => {
                            audio.currentTime = currentLyrics[idx].time;
                        });
                    });
                    
                } else {
                    lyricsContent.innerHTML = '<p class="text-white/50 text-sm mt-20">ê°€ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } else {
                lyricsContent.innerHTML = '<p class="text-white/50 text-sm mt-20">ê°€ì‚¬ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
            }
        };

        const openPlayer = (index) => {
            if (currentIdx === index && !audio.paused) {
                playerScreen.classList.remove('translate-y-full');
                miniPlayer.classList.remove('translate-y-full');
                return;
            }
            const songToPlay = songs[index];
            incrementPlayCount(songToPlay.id);
            currentIdx = index;
            loadSongData(index);
            playerScreen.classList.remove('translate-y-full');
            miniPlayer.classList.remove('translate-y-full');
            setTimeout(() => togglePlay(true), 300);
        };

        const togglePlay = (forcePlay = null) => {
            const shouldPlay = forcePlay === null ? audio.paused : forcePlay;
            if (shouldPlay) {
                audio.play().then(() => updateUI(true)).catch(e => {
                    console.error(e);
                    errorBox.classList.remove('hidden');
                    updateUI(false);
                });
            } else {
                audio.pause();
                updateUI(false);
            }
        };

        const updateUI = (playing) => {
            isPlaying = playing;
            if (playing) {
                miniIconPlay.classList.add('hidden'); miniIconPause.classList.remove('hidden');
                iconPlay.classList.add('hidden'); iconPause.classList.remove('hidden');
                lpDisk.classList.add('running');
                toneArm.style.transform = "rotate(10deg)";
                if('mediaSession' in navigator) navigator.mediaSession.playbackState = "playing";
            } else {
                miniIconPlay.classList.remove('hidden'); miniIconPause.classList.add('hidden');
                iconPlay.classList.remove('hidden'); iconPause.classList.add('hidden');
                lpDisk.classList.remove('running');
                toneArm.style.transform = "rotate(-25deg)";
                if('mediaSession' in navigator) navigator.mediaSession.playbackState = "paused";
            }
        };

        miniPlayer.addEventListener('click', () => playerScreen.classList.remove('translate-y-full'));
        document.getElementById('btn-minimize').onclick = () => playerScreen.classList.add('translate-y-full');
        
        btnPlay.addEventListener('click', () => togglePlay());
        miniPlayBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });
        
        document.getElementById('btn-next').addEventListener('click', () => {
            let nextIdx = currentIdx + 1;
            if (nextIdx >= songs.length) nextIdx = 0;
            openPlayer(nextIdx);
        });
        document.getElementById('btn-prev').addEventListener('click', () => {
            let prevIdx = currentIdx - 1;
            if (prevIdx < 0) prevIdx = songs.length - 1;
            openPlayer(prevIdx);
        });

        audio.addEventListener('ended', () => { 
            if (isRepeat) {
                audio.currentTime = 0; audio.play();
            } else {
                let nextIdx = currentIdx + 1;
                if (nextIdx < songs.length) {
                     openPlayer(nextIdx);
                } else {
                    togglePlay(false); 
                    audio.currentTime = 0; 
                }
            }
        });

        btnMoreChart.onclick = () => fullChartView.classList.remove('translate-x-full');
        btnCloseChart.onclick = () => fullChartView.classList.add('translate-x-full');
        
        btnPlayAll.onclick = () => {
             openPlayer(0);
        };

        btnRepeat.onclick = () => {
            isRepeat = !isRepeat;
            if (isRepeat) {
                btnRepeat.classList.remove('text-white/30');
                btnRepeat.classList.add('text-[#005ED2]');
            } else {
                btnRepeat.classList.add('text-white/30');
                btnRepeat.classList.remove('text-[#005ED2]');
            }
        };

        function getClientX(e) { return e.touches ? e.touches[0].clientX : e.clientX; }
        function onScrub(e) {
            const rect = document.getElementById('progress-container').getBoundingClientRect();
            return Math.max(0, Math.min(100, ((getClientX(e) - rect.left) / rect.width) * 100));
        }
        const startScrub = (e) => {
            isDragging = true;
            progressFill.style.width = `${onScrub(e)}%`;
            progressFill.classList.add('no-transition');
        };
        const moveScrub = (e) => {
            if (isDragging) {
                e.preventDefault();
                progressFill.style.width = `${onScrub(e)}%`;
            }
        };
        const endScrub = (e) => {
            if (isDragging) {
                isDragging = false;
                if(audio.duration) audio.currentTime = (parseFloat(progressFill.style.width) / 100) * audio.duration;
                progressFill.classList.remove('no-transition');
            }
        };
        const pContainer = document.getElementById('progress-container');
        pContainer.addEventListener('mousedown', startScrub);
        pContainer.addEventListener('touchstart', startScrub, {passive: false});
        document.addEventListener('mousemove', moveScrub);
        document.addEventListener('touchmove', moveScrub, {passive: false});
        document.addEventListener('mouseup', endScrub);
        document.addEventListener('touchend', endScrub);

        function formatTime(s) {
            if (typeof s !== 'number' || isNaN(s) || !isFinite(s)) return "00:00";
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${min}:${sec < 10 ? '0'+sec : sec}`;
        }

        function updateTimeDisplay() {
            if (timeCurr) timeCurr.innerText = formatTime(audio.currentTime);
            if (timeDur && audio.duration) timeDur.innerText = formatTime(audio.duration);
            if (!isDragging && audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                if(progressFill) progressFill.style.width = `${percent}%`;
                if(progressHandle) progressHandle.style.left = `${percent}%`;
                if(seekSlider) seekSlider.value = percent;
                const miniProg = document.getElementById('mini-progress');
                if(miniProg) miniProg.style.width = `${percent}%`;
            }
            syncLyrics();
        }

        audio.addEventListener('timeupdate', updateTimeDisplay);
        audio.addEventListener('loadedmetadata', updateTimeDisplay);
        audio.addEventListener('durationchange', updateTimeDisplay);

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    setupRealtimeListener();
                    setupNoticeListener(); 
                } else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        signInAnonymously(auth);
                    }
                }
            });
        } else {
            renderAll();
        }

        loadSongData(0);
    </script>
</body>
</html>