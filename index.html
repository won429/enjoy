import React, { useState, useRef, useEffect } from 'react';
import { Play, Pause, SkipBack, SkipForward, ListMusic, AlertCircle, Shuffle, Repeat } from 'lucide-react'; // Shuffle, Repeat ì•„ì´ì½˜ ì¶”ê°€

const App = () => {
  // ğŸµ ê¸°ë³¸ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸
  const defaultPlaylist = [
    {
      id: 1,
      title: "ë¹›", 
      artist: "ì—”ìª½ì´ OST Part.1",
      src: "https://files.catbox.moe/77ewj6.mp3", 
      cover: "https://files.catbox.moe/gcuicg.jpg"
    }
  ];

  const [playlist, setPlaylist] = useState(defaultPlaylist);
  const [currentSongIndex, setCurrentSongIndex] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);
  const [showPlaylist, setShowPlaylist] = useState(false);
  const [errorMsg, setErrorMsg] = useState(""); 
  const [isShuffle, setIsShuffle] = useState(false); // ì…”í”Œ ìƒíƒœ
  const [isRepeat, setIsRepeat] = useState(false); // ë°˜ë³µ ì¬ìƒ ìƒíƒœ
  
  const audioRef = useRef(null);
  const currentSong = playlist[currentSongIndex];

  // ê³¡ ë³€ê²½ ì‹œ ì—ëŸ¬ ì´ˆê¸°í™” ë° ìë™ ì¬ìƒ ì‹œë„
  useEffect(() => {
    setErrorMsg(""); 
    if (audioRef.current) {
      audioRef.current.load(); 
      if (isPlaying) {
        const playPromise = audioRef.current.play();
        if (playPromise !== undefined) {
          playPromise.catch(e => {
            console.log("ìë™ ì¬ìƒ ì°¨ë‹¨:", e);
            setIsPlaying(false);
          });
        }
      }
    }
  }, [currentSongIndex, playlist]);

  // ì¬ìƒ ìƒíƒœ ë³€ê²½
  useEffect(() => {
    if (audioRef.current) {
      if (isPlaying) {
        const playPromise = audioRef.current.play();
        if (playPromise !== undefined) {
            playPromise.catch(e => console.error("ì¬ìƒ ì‹¤íŒ¨:", e));
        }
      } else {
        audioRef.current.pause();
      }
    }
  }, [isPlaying]);

  // ì—ëŸ¬ í•¸ë“¤ëŸ¬
  const handleAudioError = (e) => {
    console.error("ì˜¤ë””ì˜¤ ë¡œë“œ ì—ëŸ¬:", e);
    setIsPlaying(false);
    if (currentSong.src.includes("drive.google.com")) {
        setErrorMsg("êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë§í¬ëŠ” ì¬ìƒë¶ˆê°€. ìº£ë°•ìŠ¤ë¥¼ ì´ìš©í•˜ì„¸ìš”.");
    } else {
        setErrorMsg("ìŒì› ì£¼ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  };

  // ì´ì „/ë‹¤ìŒ ê³¡
  const playNext = () => {
    setCurrentSongIndex((prev) => (prev + 1) % playlist.length);
    setIsPlaying(true);
  };
  const playPrev = () => {
    setCurrentSongIndex((prev) => (prev - 1 + playlist.length) % playlist.length);
    setIsPlaying(true);
  };

  // ì‹œê°„ ì—…ë°ì´íŠ¸
  const onTimeUpdate = () => {
    if (audioRef.current) {
      setCurrentTime(audioRef.current.currentTime);
      setDuration(audioRef.current.duration || 0);
    }
  };

  const handleProgressChange = (e) => {
    const newTime = e.target.value;
    audioRef.current.currentTime = newTime;
    setCurrentTime(newTime);
  };

  const formatTime = (time) => {
    if (isNaN(time)) return "00:00";
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
  };

  return (
    <div className="min-h-screen bg-gray-950 flex items-center justify-center p-6 font-sans overflow-hidden relative select-none">
      
      {/* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */}
      <style>{`
        @keyframes spin-lp {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `}</style>

      {/* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ */}
      <div className="absolute inset-0">
        <img 
            src={currentSong.cover} 
            alt="bg" 
            className="w-full h-full object-cover opacity-30 blur-3xl scale-125 transition-all duration-1000"
        />
        <div className="absolute inset-0 bg-black/40"></div>
      </div>

      <div className="bg-white/5 backdrop-blur-2xl border border-white/10 p-8 rounded-[40px] shadow-2xl w-full max-w-md relative z-10 overflow-hidden flex flex-col min-h-[640px]">
        
        {/* ìƒë‹¨ í—¤ë” (ì¬ìƒëª©ë¡ ë²„íŠ¼ ë°°ì¹˜) */}
        <div className="flex justify-between items-center mb-8 relative">
          {/* ì™¼ìª½: ë¹ˆ ê³µê°„ (ê· í˜•ì„ ìœ„í•´) */}
          <div className="w-10"></div>
          
          {/* ì¤‘ì•™: NOW PLAYING */}
          <div className="flex items-center gap-2 px-4 py-1 bg-white/5 rounded-full border border-white/5">
            <span className={`w-2 h-2 rounded-full ${isPlaying ? 'bg-green-400 animate-pulse' : 'bg-white/30'}`}></span>
            <span className="text-[10px] font-bold tracking-[0.2em] text-white/80">NOW PLAYING</span>
          </div>
          
          {/* ì˜¤ë¥¸ìª½: ì¬ìƒëª©ë¡ ë²„íŠ¼ (ì›ë˜ ìœ„ì¹˜ë¡œ ì´ë™) */}
          <button 
            onClick={() => setShowPlaylist(!showPlaylist)}
            className={`p-2 rounded-full transition-colors ${showPlaylist ? 'bg-white text-black shadow-lg' : 'text-white/40 hover:text-white hover:bg-white/5'}`}
          >
            <ListMusic size={22} />
          </button>
        </div>

        {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
        {errorMsg && (
            <div className="bg-red-500/90 text-white text-xs p-3 rounded-xl mb-4 flex items-center gap-2 justify-center animate-bounce">
                <AlertCircle size={16} /> {errorMsg}
            </div>
        )}

        {/* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */}
        {!showPlaylist ? (
            <div className="flex-1 flex flex-col animate-fade-in">
                {/* ì•¨ë²” ì•„íŠ¸ (íšŒì „í•˜ëŠ” LPíŒ ìŠ¤íƒ€ì¼ ê°•í™”) */}
                <div className="relative w-72 h-72 mx-auto mb-10 group">
                    <div 
                        className="w-full h-full rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.5)] border-8 border-gray-900 overflow-hidden relative bg-gray-900"
                        style={{ 
                            animation: isPlaying ? 'spin-lp 10s linear infinite' : 'none',
                        }}
                    >   
                        {/* ì•¨ë²” ì»¤ë²„ ì´ë¯¸ì§€ (LP ë¼ë²¨ì²˜ëŸ¼ ì‘ê²Œ) */}
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-40 h-40 rounded-full overflow-hidden border-4 border-gray-800/50 z-10">
                             <img src={currentSong.cover} alt="Album Art" className="w-full h-full object-cover opacity-90" />
                        </div>

                        {/* LPíŒ ì§ˆê° ë° ê·¸ë£¨ë¸Œ */}
                        <div className="absolute inset-0 rounded-full bg-[conic-gradient(from_0deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05),rgba(255,255,255,0.1))] pointer-events-none"></div>
                        <div className="absolute inset-0 rounded-full border-[2px] border-white/5 pointer-events-none" style={{clipPath: 'circle(48%)'}}></div>
                        <div className="absolute inset-0 rounded-full border-[2px] border-white/5 pointer-events-none" style={{clipPath: 'circle(40%)'}}></div>
                        <div className="absolute inset-0 rounded-full border-[2px] border-white/5 pointer-events-none" style={{clipPath: 'circle(32%)'}}></div>

                        
                        {/* ì¤‘ì•™ êµ¬ë© (ìŠ¤í•€ë“¤) */}
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-white/80 rounded-full border-2 border-gray-400 shadow-inner z-20">
                        </div>
                    </div>

                    {/* ì¤‘ì•™ ì¬ìƒ ë²„íŠ¼ (ì •ì§€ ì‹œì—ë§Œ í‘œì‹œ) */}
                    {!isPlaying && (
                        <div 
                            className="absolute inset-0 flex items-center justify-center z-30 cursor-pointer"
                            onClick={() => setIsPlaying(true)}
                        >
                            <div className="w-20 h-20 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center hover:bg-white/30 transition-all hover:scale-105">
                                <Play size={36} fill="white" className="text-white ml-1" />
                            </div>
                        </div>
                    )}
                </div>

                {/* ê³¡ ì •ë³´ */}
                <div className="text-center mb-8 px-4">
                    <h2 className="text-2xl font-bold text-white mb-2 truncate drop-shadow-md tracking-tight">
                        {currentSong.title}
                    </h2>
                    <p className="text-white/50 text-sm font-medium tracking-wide uppercase">
                        {currentSong.artist}
                    </p>
                </div>

                {/* ì§„í–‰ ë°” */}
                <div className="mb-4 px-2">
                    <div className="flex justify-between text-[10px] text-white/40 mb-2 font-mono tracking-wider">
                        <span>{formatTime(currentTime)}</span>
                        <span>{formatTime(duration)}</span>
                    </div>
                    <div className="relative h-1.5 bg-white/10 rounded-full cursor-pointer group py-2" onClick={(e) => {
                         const rect = e.currentTarget.getBoundingClientRect();
                         const percent = (e.clientX - rect.left) / rect.width;
                         if(audioRef.current) audioRef.current.currentTime = percent * duration;
                    }}>
                         {/* ì‹¤ì œ ë°” ë¼ì¸ */}
                        <div className="absolute top-1/2 -translate-y-1/2 left-0 right-0 h-1.5 bg-white/10 rounded-full overflow-hidden">
                             <div 
                                className="h-full bg-white rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)]"
                                style={{ width: `${duration ? (currentTime / duration) * 100 : 0}%` }}
                            ></div>
                        </div>
                        {/* ë“œë˜ê·¸ í•¸ë“¤ (í˜¸ë²„ì‹œ í‘œì‹œ) */}
                        <div 
                            className="absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"
                            style={{ left: `${duration ? (currentTime / duration) * 100 : 0}%` }}
                        ></div>
                        
                        <input
                            type="range"
                            min="0"
                            max={duration || 100}
                            value={currentTime}
                            onChange={handleProgressChange}
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                        />
                    </div>
                </div>
            </div>
        ) : (
            /* ì¬ìƒëª©ë¡ í™”ë©´ */
            <div className="flex-1 overflow-y-auto mb-6 pr-2 animate-fade-in">
                <h3 className="text-white/90 text-lg font-bold mb-6 px-2 flex items-center gap-2">
                    <ListMusic size={20} /> Playlist
                </h3>
                <div className="space-y-3">
                    {playlist.map((song, idx) => (
                        <div 
                            key={song.id}
                            onClick={() => { setCurrentSongIndex(idx); setIsPlaying(true); }}
                            className={`flex items-center gap-4 p-4 rounded-2xl cursor-pointer transition-all ${currentSongIndex === idx ? 'bg-white/10 border border-white/10' : 'hover:bg-white/5 border border-transparent'}`}
                        >
                            <div className="relative w-12 h-12 rounded-lg overflow-hidden flex-shrink-0 bg-gray-800 shadow-lg">
                                <img src={song.cover} className="w-full h-full object-cover" />
                                {currentSongIndex === idx && isPlaying && (
                                    <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
                                        <div className="w-1.5 h-1.5 bg-white rounded-full animate-ping"></div>
                                    </div>
                                )}
                            </div>
                            <div className="flex-1 min-w-0">
                                <h4 className={`text-sm font-bold truncate ${currentSongIndex === idx ? 'text-white' : 'text-white/70'}`}>
                                    {song.title}
                                </h4>
                                <p className="text-xs text-white/40 truncate mt-1">{song.artist}</p>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        )}

        {/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” (ì…”í”Œ, ì´ì „, ì¬ìƒ, ë‹¤ìŒ, ë°˜ë³µ ë²„íŠ¼) */}
        <div className="mt-auto pt-6 border-t border-white/5 flex items-center justify-between relative px-4">
            
            {/* ì…”í”Œ ë²„íŠ¼ */}
            <button 
                onClick={() => setIsShuffle(!isShuffle)}
                className={`p-2 rounded-full transition-colors ${isShuffle ? 'text-green-400 hover:text-green-300' : 'text-white/40 hover:text-white'}`}
            >
                <Shuffle size={24} />
            </button>

            {/* ì´ì „ ê³¡ ë²„íŠ¼ */}
            <button onClick={playPrev} className="text-white/40 hover:text-white transition-colors active:scale-90 p-2">
                <SkipBack size={32} />
            </button>
            
            {/* ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ */}
            <button 
                onClick={() => setIsPlaying(!isPlaying)}
                className="w-16 h-16 flex items-center justify-center bg-white text-black rounded-full shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-105 hover:shadow-[0_0_30px_rgba(255,255,255,0.5)] transition-all active:scale-95 active:shadow-none"
            >
                {isPlaying ? <Pause size={36} fill="currentColor" /> : <Play size={36} fill="currentColor" className="ml-1" />}
            </button>
            
            {/* ë‹¤ìŒ ê³¡ ë²„íŠ¼ */}
            <button onClick={playNext} className="text-white/40 hover:text-white transition-colors active:scale-90 p-2">
                <SkipForward size={32} />
            </button>

            {/* ë°˜ë³µ ì¬ìƒ ë²„íŠ¼ */}
            <button 
                onClick={() => setIsRepeat(!isRepeat)}
                className={`p-2 rounded-full transition-colors ${isRepeat ? 'text-green-400 hover:text-green-300' : 'text-white/40 hover:text-white'}`}
            >
                <Repeat size={24} />
            </button>

        </div>

        {/* ì˜¤ë””ì˜¤ íƒœê·¸ */}
        <audio 
          ref={audioRef} 
          src={currentSong.src} 
          onTimeUpdate={onTimeUpdate} 
          onEnded={playNext}
          onError={handleAudioError}
          crossOrigin="anonymous"
          volume={1.0} // ë³¼ë¥¨ ì¡°ì ˆ ê¸°ëŠ¥ì´ ì—†ì–´ì¡Œìœ¼ë¯€ë¡œ ìµœëŒ€ ë³¼ë¥¨ìœ¼ë¡œ ê³ ì •
        />

      </div>
    </div>
  );
};

export default App;